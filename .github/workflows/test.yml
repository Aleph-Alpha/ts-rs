on: [push, pull_request]
name: Test
jobs:
  e2e-dependencies:
    name: Run 'dependencies' end-to-end test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: dependencies e2e test
        working-directory: e2e/dependencies/consumer
        run: |
          cargo t 
          tsc bindings/* --noEmit --noUnusedLocals --strict
      - name: dependencies e2e test with default export env
        working-directory: e2e/dependencies/consumer
        run: |
          TS_RS_EXPORT_DIR=custom-bindings cargo t 
          shopt -s globstar
          tsc custom-bindings/**/*.ts --noEmit --noUnusedLocals --strict
  e2e-workspace:
    name: Run 'workspace' end-to-end test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: workspace e2e test
        working-directory: e2e/workspace
        run: |
          cargo t 
          shopt -s globstar
          tsc parent/bindings/**/*.ts --noEmit --noUnusedLocals --strict
          rm -rf parent/bindings
      - name: workspace e2e with default export env
        working-directory: e2e/workspace
        run: |
          TS_RS_EXPORT_DIR=custom-bindings cargo t 
          shopt -s globstar
          tsc parent/custom-bindings/**/*.ts --noEmit --noUnusedLocals --strict
          rm -rf parent/custom-bindings
  e2e-example:
    name: End-to-end test example
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: example e2e test
        working-directory: example
        run: |
          cargo t 
          tsc bindings/* --noEmit
      - name: example e2e with default export env
        working-directory: example
        run: |
          TS_RS_EXPORT_DIR=custom-bindings cargo t 
          shopt -s globstar
          tsc custom-bindings/**/*.ts --noEmit --noUnusedLocals --strict

  readme-up-to-date:
    name: Check that README.md is up-to-date
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Check that README.md is up-to-date
        working-directory: ts-rs
        run: |
          cargo install cargo-readme 
          diff -u ../README.md <(cargo readme)

  test:
    name: Test ts-rs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: All features
        run: |
          cargo test --all-features
          shopt -s globstar
          tsc ts-rs/bindings/tests-out/**/*.ts --noEmit --noUnusedLocals --strict
          rm -rf ts-rs/bindings
      - name: Test with export env
        run: |
          TS_RS_EXPORT_DIR=output cargo test --no-default-features
          shopt -s globstar
          tsc ts-rs/output/tests-out/**/*.ts --noEmit --noUnusedLocals --strict
          rm -rf ts-rs/output
      - name: No features
        run: |
          cargo test --no-default-features
          shopt -s globstar
          tsc ts-rs/bindings/tests-out/**/*.ts --noEmit --noUnusedLocals
          rm -rf ts-rs/bindings
